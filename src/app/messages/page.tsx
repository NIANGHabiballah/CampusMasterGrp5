'use client';\n\nimport { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Badge } from '@/components/ui/badge';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { \n  MessageSquare, \n  Send, \n  Search, \n  Filter, \n  Plus, \n  Users, \n  Tag, \n  Clock,\n  CheckCircle,\n  AlertCircle,\n  Star,\n  Archive,\n  Trash2\n} from 'lucide-react';\nimport { useAuthStore } from '@/store/auth';\nimport { toast } from 'sonner';\nimport { format } from 'date-fns';\nimport { fr } from 'date-fns/locale';\n\ninterface Message {\n  id: string;\n  senderId: string;\n  senderName: string;\n  senderRole: string;\n  receiverId?: string;\n  receiverName?: string;\n  courseId?: string;\n  courseName?: string;\n  subject: string;\n  content: string;\n  tags: string[];\n  isRead: boolean;\n  isStarred: boolean;\n  isArchived: boolean;\n  createdAt: string;\n  attachments?: any[];\n}\n\nconst mockMessages: Message[] = [\n  {\n    id: '1',\n    senderId: '2',\n    senderName: 'Prof. Jean Martin',\n    senderRole: 'TEACHER',\n    receiverId: '3',\n    receiverName: 'Marie Dupont',\n    subject: 'Feedback sur votre projet React',\n    content: 'Bonjour Marie, j\\'ai corrigé votre projet React. Excellent travail ! Quelques points d\\'amélioration : la gestion des erreurs pourrait être renforcée et l\\'interface utilisateur est très intuitive. Continuez ainsi !',\n    tags: ['feedback', 'projet'],\n    isRead: false,\n    isStarred: true,\n    isArchived: false,\n    createdAt: '2024-01-24T10:30:00Z'\n  },\n  {\n    id: '2',\n    senderId: '1',\n    senderName: 'Admin Système',\n    senderRole: 'ADMIN',\n    courseId: '1',\n    courseName: 'React Avancé',\n    subject: 'Nouvelle fonctionnalité disponible',\n    content: 'Une nouvelle fonctionnalité de collaboration en temps réel a été ajoutée à la plateforme. Vous pouvez maintenant travailler simultanément sur vos projets.',\n    tags: ['annonce', 'nouveau'],\n    isRead: true,\n    isStarred: false,\n    isArchived: false,\n    createdAt: '2024-01-23T14:15:00Z'\n  },\n  {\n    id: '3',\n    senderId: '3',\n    senderName: 'Marie Dupont',\n    senderRole: 'STUDENT',\n    receiverId: '2',\n    receiverName: 'Prof. Jean Martin',\n    subject: 'Question sur l\\'architecture des composants',\n    content: 'Bonjour Professeur, j\\'ai une question concernant l\\'architecture des composants React. Comment organiser efficacement les composants dans une application complexe ?',\n    tags: ['question', 'urgent'],\n    isRead: true,\n    isStarred: false,\n    isArchived: false,\n    createdAt: '2024-01-22T16:45:00Z'\n  }\n];\n\nconst availableTags = [\n  { value: 'urgent', label: 'Urgent', color: 'bg-red-100 text-red-800' },\n  { value: 'annonce', label: 'Annonce', color: 'bg-blue-100 text-blue-800' },\n  { value: 'projet', label: 'Projet', color: 'bg-green-100 text-green-800' },\n  { value: 'question', label: 'Question', color: 'bg-yellow-100 text-yellow-800' },\n  { value: 'feedback', label: 'Feedback', color: 'bg-purple-100 text-purple-800' },\n  { value: 'nouveau', label: 'Nouveau', color: 'bg-indigo-100 text-indigo-800' }\n];\n\nexport default function MessagesPage() {\n  const { user } = useAuthStore();\n  const [messages, setMessages] = useState<Message[]>(mockMessages);\n  const [selectedMessage, setSelectedMessage] = useState<Message | null>(null);\n  const [isComposeOpen, setIsComposeOpen] = useState(false);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [selectedTags, setSelectedTags] = useState<string[]>([]);\n  const [activeTab, setActiveTab] = useState('inbox');\n  \n  // Compose message form\n  const [newMessage, setNewMessage] = useState({\n    receiverId: '',\n    courseId: '',\n    subject: '',\n    content: '',\n    tags: [] as string[]\n  });\n\n  const handleSendMessage = () => {\n    if (!newMessage.subject || !newMessage.content) {\n      toast.error('Veuillez remplir tous les champs obligatoires');\n      return;\n    }\n\n    const message: Message = {\n      id: `msg-${Date.now()}`,\n      senderId: user?.id || '',\n      senderName: `${user?.firstName} ${user?.lastName}`,\n      senderRole: user?.role || 'STUDENT',\n      receiverId: newMessage.receiverId || undefined,\n      receiverName: newMessage.receiverId ? 'Destinataire' : undefined,\n      courseId: newMessage.courseId || undefined,\n      courseName: newMessage.courseId ? 'Cours sélectionné' : undefined,\n      subject: newMessage.subject,\n      content: newMessage.content,\n      tags: newMessage.tags,\n      isRead: false,\n      isStarred: false,\n      isArchived: false,\n      createdAt: new Date().toISOString()\n    };\n\n    setMessages([message, ...messages]);\n    setNewMessage({ receiverId: '', courseId: '', subject: '', content: '', tags: [] });\n    setIsComposeOpen(false);\n    toast.success('Message envoyé avec succès');\n  };\n\n  const handleTagToggle = (tag: string) => {\n    setNewMessage(prev => ({\n      ...prev,\n      tags: prev.tags.includes(tag) \n        ? prev.tags.filter(t => t !== tag)\n        : [...prev.tags, tag]\n    }));\n  };\n\n  const toggleMessageStar = (messageId: string) => {\n    setMessages(prev => prev.map(msg => \n      msg.id === messageId ? { ...msg, isStarred: !msg.isStarred } : msg\n    ));\n  };\n\n  const markAsRead = (messageId: string) => {\n    setMessages(prev => prev.map(msg => \n      msg.id === messageId ? { ...msg, isRead: true } : msg\n    ));\n  };\n\n  const archiveMessage = (messageId: string) => {\n    setMessages(prev => prev.map(msg => \n      msg.id === messageId ? { ...msg, isArchived: true } : msg\n    ));\n    toast.success('Message archivé');\n  };\n\n  const filteredMessages = messages.filter(msg => {\n    const matchesSearch = msg.subject.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         msg.content.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         msg.senderName.toLowerCase().includes(searchTerm.toLowerCase());\n    \n    const matchesTags = selectedTags.length === 0 || \n                       selectedTags.some(tag => msg.tags.includes(tag));\n    \n    const matchesTab = (() => {\n      switch (activeTab) {\n        case 'inbox': return !msg.isArchived && (msg.receiverId === user?.id || msg.courseId);\n        case 'sent': return msg.senderId === user?.id;\n        case 'starred': return msg.isStarred;\n        case 'archived': return msg.isArchived;\n        default: return true;\n      }\n    })();\n    \n    return matchesSearch && matchesTags && matchesTab;\n  });\n\n  const getTagStyle = (tag: string) => {\n    const tagConfig = availableTags.find(t => t.value === tag);\n    return tagConfig?.color || 'bg-gray-100 text-gray-800';\n  };\n\n  return (\n    <div className=\"container mx-auto p-6\">\n      {/* Header */}\n      <div className=\"flex justify-between items-center mb-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-gray-900\">Messages</h1>\n          <p className=\"text-gray-600 mt-1\">Communiquez avec vos enseignants et étudiants</p>\n        </div>\n        \n        <Dialog open={isComposeOpen} onOpenChange={setIsComposeOpen}>\n          <DialogTrigger asChild>\n            <Button className=\"bg-blue-600 hover:bg-blue-700\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Nouveau message\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>Composer un message</DialogTitle>\n              <DialogDescription>\n                Envoyez un message à un utilisateur ou à un groupe de cours\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"recipient\">Destinataire</Label>\n                  <Select value={newMessage.receiverId} onValueChange={(value) => setNewMessage({...newMessage, receiverId: value})}>\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Sélectionner un destinataire\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"1\">Admin Système</SelectItem>\n                      <SelectItem value=\"2\">Prof. Jean Martin</SelectItem>\n                      <SelectItem value=\"3\">Marie Dupont</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                \n                <div>\n                  <Label htmlFor=\"course\">Groupe de cours (optionnel)</Label>\n                  <Select value={newMessage.courseId} onValueChange={(value) => setNewMessage({...newMessage, courseId: value})}>\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Sélectionner un cours\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"1\">React Avancé</SelectItem>\n                      <SelectItem value=\"2\">Node.js Backend</SelectItem>\n                      <SelectItem value=\"3\">Base de Données</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n              \n              <div>\n                <Label htmlFor=\"subject\">Sujet</Label>\n                <Input\n                  id=\"subject\"\n                  value={newMessage.subject}\n                  onChange={(e) => setNewMessage({...newMessage, subject: e.target.value})}\n                  placeholder=\"Sujet du message\"\n                />\n              </div>\n              \n              <div>\n                <Label htmlFor=\"content\">Message</Label>\n                <Textarea\n                  id=\"content\"\n                  value={newMessage.content}\n                  onChange={(e) => setNewMessage({...newMessage, content: e.target.value})}\n                  placeholder=\"Tapez votre message ici...\"\n                  rows={6}\n                />\n              </div>\n              \n              <div>\n                <Label>Tags</Label>\n                <div className=\"flex flex-wrap gap-2 mt-2\">\n                  {availableTags.map(tag => (\n                    <div key={tag.value} className=\"flex items-center space-x-2\">\n                      <Checkbox\n                        id={tag.value}\n                        checked={newMessage.tags.includes(tag.value)}\n                        onCheckedChange={() => handleTagToggle(tag.value)}\n                      />\n                      <Label htmlFor={tag.value} className={`px-2 py-1 rounded-full text-xs ${tag.color}`}>\n                        {tag.label}\n                      </Label>\n                    </div>\n                  ))}\n                </div>\n              </div>\n              \n              <div className=\"flex justify-end space-x-2\">\n                <Button variant=\"outline\" onClick={() => setIsComposeOpen(false)}>\n                  Annuler\n                </Button>\n                <Button onClick={handleSendMessage}>\n                  <Send className=\"w-4 h-4 mr-2\" />\n                  Envoyer\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Sidebar */}\n        <div className=\"lg:col-span-1\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg\">Boîte de réception</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {/* Search */}\n              <div className=\"relative mb-4\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4\" />\n                <Input\n                  placeholder=\"Rechercher des messages...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-10\"\n                />\n              </div>\n              \n              {/* Tabs */}\n              <Tabs value={activeTab} onValueChange={setActiveTab}>\n                <TabsList className=\"grid w-full grid-cols-2\">\n                  <TabsTrigger value=\"inbox\">Reçus</TabsTrigger>\n                  <TabsTrigger value=\"sent\">Envoyés</TabsTrigger>\n                </TabsList>\n                <TabsList className=\"grid w-full grid-cols-2 mt-2\">\n                  <TabsTrigger value=\"starred\">Favoris</TabsTrigger>\n                  <TabsTrigger value=\"archived\">Archivés</TabsTrigger>\n                </TabsList>\n              </Tabs>\n              \n              {/* Tag Filters */}\n              <div className=\"mt-4\">\n                <Label className=\"text-sm font-medium\">Filtrer par tags</Label>\n                <div className=\"flex flex-wrap gap-1 mt-2\">\n                  {availableTags.map(tag => (\n                    <Badge\n                      key={tag.value}\n                      variant={selectedTags.includes(tag.value) ? \"default\" : \"outline\"}\n                      className=\"cursor-pointer text-xs\"\n                      onClick={() => {\n                        setSelectedTags(prev => \n                          prev.includes(tag.value)\n                            ? prev.filter(t => t !== tag.value)\n                            : [...prev, tag.value]\n                        );\n                      }}\n                    >\n                      {tag.label}\n                    </Badge>\n                  ))}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Messages List */}\n        <div className=\"lg:col-span-2\">\n          <div className=\"space-y-4\">\n            {filteredMessages.length === 0 ? (\n              <Card>\n                <CardContent className=\"text-center py-12\">\n                  <MessageSquare className=\"w-12 h-12 text-gray-400 mx-auto mb-4\" />\n                  <h3 className=\"text-lg font-medium text-gray-900 mb-2\">Aucun message</h3>\n                  <p className=\"text-gray-600\">Aucun message ne correspond à vos critères de recherche.</p>\n                </CardContent>\n              </Card>\n            ) : (\n              filteredMessages.map(message => (\n                <Card \n                  key={message.id} \n                  className={`cursor-pointer hover:shadow-md transition-shadow ${\n                    !message.isRead ? 'border-blue-200 bg-blue-50' : ''\n                  }`}\n                  onClick={() => {\n                    setSelectedMessage(message);\n                    if (!message.isRead) markAsRead(message.id);\n                  }}\n                >\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex justify-between items-start mb-2\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center space-x-2 mb-1\">\n                          <h4 className={`font-medium ${!message.isRead ? 'font-bold' : ''}`}>\n                            {message.subject}\n                          </h4>\n                          {!message.isRead && (\n                            <div className=\"w-2 h-2 bg-blue-500 rounded-full\"></div>\n                          )}\n                        </div>\n                        <p className=\"text-sm text-gray-600\">\n                          {activeTab === 'sent' ? `À: ${message.receiverName || message.courseName}` : `De: ${message.senderName}`}\n                        </p>\n                      </div>\n                      \n                      <div className=\"flex items-center space-x-2\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            toggleMessageStar(message.id);\n                          }}\n                        >\n                          <Star className={`w-4 h-4 ${message.isStarred ? 'fill-yellow-400 text-yellow-400' : 'text-gray-400'}`} />\n                        </Button>\n                        \n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            archiveMessage(message.id);\n                          }}\n                        >\n                          <Archive className=\"w-4 h-4 text-gray-400\" />\n                        </Button>\n                      </div>\n                    </div>\n                    \n                    <p className=\"text-sm text-gray-700 line-clamp-2 mb-2\">\n                      {message.content}\n                    </p>\n                    \n                    <div className=\"flex justify-between items-center\">\n                      <div className=\"flex flex-wrap gap-1\">\n                        {message.tags.map(tag => (\n                          <Badge key={tag} className={`text-xs ${getTagStyle(tag)}`}>\n                            {availableTags.find(t => t.value === tag)?.label || tag}\n                          </Badge>\n                        ))}\n                      </div>\n                      \n                      <span className=\"text-xs text-gray-500\">\n                        {format(new Date(message.createdAt), 'dd MMM yyyy à HH:mm', { locale: fr })}\n                      </span>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Message Detail Modal */}\n      {selectedMessage && (\n        <Dialog open={!!selectedMessage} onOpenChange={() => setSelectedMessage(null)}>\n          <DialogContent className=\"max-w-3xl\">\n            <DialogHeader>\n              <DialogTitle>{selectedMessage.subject}</DialogTitle>\n              <DialogDescription>\n                De: {selectedMessage.senderName} • {format(new Date(selectedMessage.createdAt), 'dd MMM yyyy à HH:mm', { locale: fr })}\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div className=\"flex flex-wrap gap-1\">\n                {selectedMessage.tags.map(tag => (\n                  <Badge key={tag} className={`text-xs ${getTagStyle(tag)}`}>\n                    {availableTags.find(t => t.value === tag)?.label || tag}\n                  </Badge>\n                ))}\n              </div>\n              \n              <div className=\"bg-gray-50 p-4 rounded-lg\">\n                <p className=\"whitespace-pre-wrap\">{selectedMessage.content}</p>\n              </div>\n              \n              <div className=\"flex justify-end space-x-2\">\n                <Button variant=\"outline\" onClick={() => setSelectedMessage(null)}>\n                  Fermer\n                </Button>\n                <Button onClick={() => {\n                  setNewMessage({\n                    receiverId: selectedMessage.senderId,\n                    courseId: '',\n                    subject: `Re: ${selectedMessage.subject}`,\n                    content: '',\n                    tags: []\n                  });\n                  setSelectedMessage(null);\n                  setIsComposeOpen(true);\n                }}>\n                  Répondre\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      )}\n    </div>\n  );\n}"