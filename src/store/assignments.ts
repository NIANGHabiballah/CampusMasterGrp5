import { create } from 'zustand';
import { Assignment, Submission, User } from '@/types';

interface AssignmentState {
  assignments: Assignment[];
  submissions: Submission[];
  isLoading: boolean;
  error: string | null;
  
  // Assignment CRUD
  fetchAssignments: (courseId?: string) => Promise<void>;
  createAssignment: (assignment: Omit<Assignment, 'id' | 'createdAt' | 'submissions'>) => Promise<string>;
  updateAssignment: (id: string, data: Partial<Assignment>) => Promise<boolean>;
  deleteAssignment: (id: string) => Promise<boolean>;
  
  // Submission management
  submitAssignment: (assignmentId: string, files: File[], content?: string) => Promise<boolean>;
  gradeSubmission: (submissionId: string, grade: number, feedback?: string) => Promise<boolean>;
  fetchSubmissions: (assignmentId: string) => Promise<void>;
  
  // Utilities
  getAssignmentById: (id: string) => Assignment | undefined;
  getSubmissionsByStudent: (studentId: string) => Submission[];
  getSubmissionsByAssignment: (assignmentId: string) => Submission[];
}\n\n// Mock data\nlet mockAssignments: Assignment[] = [\n  {\n    id: '1',\n    courseId: '1',\n    title: 'Projet React - Todo App',\n    description: 'Créer une application Todo complète avec React, TypeScript et localStorage. L\\'application doit permettre d\\'ajouter, modifier, supprimer et marquer comme terminées des tâches.',\n    dueDate: '2024-02-15T23:59:59Z',\n    maxPoints: 20,\n    attachments: [\n      {\n        id: 'att1',\n        name: 'consignes-projet.pdf',\n        url: '/files/consignes-projet.pdf',\n        size: 245760,\n        type: 'application/pdf',\n        uploadedAt: '2024-01-20T10:00:00Z'\n      }\n    ],\n    createdAt: '2024-01-20T10:00:00Z'\n  },\n  {\n    id: '2',\n    courseId: '2',\n    title: 'API REST avec Express',\n    description: 'Développer une API REST complète avec Express.js, incluant authentification JWT, validation des données et documentation Swagger.',\n    dueDate: '2024-02-28T23:59:59Z',\n    maxPoints: 25,\n    attachments: [],\n    createdAt: '2024-01-25T14:30:00Z'\n  }\n];\n\nlet mockSubmissions: Submission[] = [\n  {\n    id: 'sub1',\n    assignmentId: '1',\n    studentId: '3',\n    studentName: 'Marie Dupont',\n    files: [\n      {\n        id: 'file1',\n        name: 'todo-app.zip',\n        url: '/uploads/todo-app.zip',\n        size: 1024000,\n        type: 'application/zip',\n        uploadedAt: '2024-02-14T18:30:00Z'\n      }\n    ],\n    submittedAt: '2024-02-14T18:30:00Z',\n    grade: 18,\n    feedback: 'Excellent travail ! L\\'interface est intuitive et le code est bien structuré. Quelques améliorations possibles sur la gestion des erreurs.',\n    status: 'graded'\n  }\n];\n\nexport const useAssignmentStore = create<AssignmentState>((set, get) => ({\n  assignments: [],\n  submissions: [],\n  isLoading: false,\n  error: null,\n\n  fetchAssignments: async (courseId?: string) => {\n    set({ isLoading: true, error: null });\n    \n    try {\n      // Simulate API call\n      await new Promise(resolve => setTimeout(resolve, 500));\n      \n      let filteredAssignments = mockAssignments;\n      if (courseId) {\n        filteredAssignments = mockAssignments.filter(a => a.courseId === courseId);\n      }\n      \n      // Add submissions to assignments\n      const assignmentsWithSubmissions = filteredAssignments.map(assignment => ({\n        ...assignment,\n        submissions: mockSubmissions.filter(s => s.assignmentId === assignment.id)\n      }));\n      \n      set({ \n        assignments: assignmentsWithSubmissions,\n        isLoading: false \n      });\n    } catch (error) {\n      set({ \n        error: 'Erreur lors du chargement des devoirs',\n        isLoading: false \n      });\n    }\n  },\n\n  createAssignment: async (assignmentData) => {\n    set({ isLoading: true, error: null });\n    \n    try {\n      // Simulate API call\n      await new Promise(resolve => setTimeout(resolve, 800));\n      \n      const newAssignment: Assignment = {\n        ...assignmentData,\n        id: `assignment-${Date.now()}`,\n        createdAt: new Date().toISOString(),\n        submissions: []\n      };\n      \n      mockAssignments.push(newAssignment);\n      \n      set(state => ({\n        assignments: [...state.assignments, newAssignment],\n        isLoading: false\n      }));\n      \n      return newAssignment.id;\n    } catch (error) {\n      set({ \n        error: 'Erreur lors de la création du devoir',\n        isLoading: false \n      });\n      throw error;\n    }\n  },\n\n  updateAssignment: async (id: string, data: Partial<Assignment>) => {\n    set({ isLoading: true, error: null });\n    \n    try {\n      // Simulate API call\n      await new Promise(resolve => setTimeout(resolve, 500));\n      \n      const assignmentIndex = mockAssignments.findIndex(a => a.id === id);\n      if (assignmentIndex === -1) {\n        throw new Error('Devoir non trouvé');\n      }\n      \n      mockAssignments[assignmentIndex] = {\n        ...mockAssignments[assignmentIndex],\n        ...data\n      };\n      \n      set(state => ({\n        assignments: state.assignments.map(a => \n          a.id === id ? { ...a, ...data } : a\n        ),\n        isLoading: false\n      }));\n      \n      return true;\n    } catch (error) {\n      set({ \n        error: 'Erreur lors de la mise à jour du devoir',\n        isLoading: false \n      });\n      return false;\n    }\n  },\n\n  deleteAssignment: async (id: string) => {\n    set({ isLoading: true, error: null });\n    \n    try {\n      // Simulate API call\n      await new Promise(resolve => setTimeout(resolve, 500));\n      \n      mockAssignments = mockAssignments.filter(a => a.id !== id);\n      mockSubmissions = mockSubmissions.filter(s => s.assignmentId !== id);\n      \n      set(state => ({\n        assignments: state.assignments.filter(a => a.id !== id),\n        submissions: state.submissions.filter(s => s.assignmentId !== id),\n        isLoading: false\n      }));\n      \n      return true;\n    } catch (error) {\n      set({ \n        error: 'Erreur lors de la suppression du devoir',\n        isLoading: false \n      });\n      return false;\n    }\n  },\n\n  submitAssignment: async (assignmentId: string, files: File[], content?: string) => {\n    set({ isLoading: true, error: null });\n    \n    try {\n      // Simulate file upload\n      await new Promise(resolve => setTimeout(resolve, 1500));\n      \n      const fileAttachments = files.map(file => ({\n        id: `file-${Date.now()}-${Math.random()}`,\n        name: file.name,\n        url: `/uploads/${file.name}`,\n        size: file.size,\n        type: file.type,\n        uploadedAt: new Date().toISOString()\n      }));\n      \n      const newSubmission: Submission = {\n        id: `sub-${Date.now()}`,\n        assignmentId,\n        studentId: '3', // Current user ID\n        studentName: 'Marie Dupont', // Current user name\n        files: fileAttachments,\n        submittedAt: new Date().toISOString(),\n        status: 'submitted'\n      };\n      \n      mockSubmissions.push(newSubmission);\n      \n      set(state => ({\n        submissions: [...state.submissions, newSubmission],\n        assignments: state.assignments.map(a => \n          a.id === assignmentId \n            ? { ...a, submissions: [...(a.submissions || []), newSubmission] }\n            : a\n        ),\n        isLoading: false\n      }));\n      \n      return true;\n    } catch (error) {\n      set({ \n        error: 'Erreur lors de la soumission du devoir',\n        isLoading: false \n      });\n      return false;\n    }\n  },\n\n  gradeSubmission: async (submissionId: string, grade: number, feedback?: string) => {\n    set({ isLoading: true, error: null });\n    \n    try {\n      // Simulate API call\n      await new Promise(resolve => setTimeout(resolve, 500));\n      \n      const submissionIndex = mockSubmissions.findIndex(s => s.id === submissionId);\n      if (submissionIndex === -1) {\n        throw new Error('Soumission non trouvée');\n      }\n      \n      mockSubmissions[submissionIndex] = {\n        ...mockSubmissions[submissionIndex],\n        grade,\n        feedback,\n        status: 'graded'\n      };\n      \n      set(state => ({\n        submissions: state.submissions.map(s => \n          s.id === submissionId \n            ? { ...s, grade, feedback, status: 'graded' }\n            : s\n        ),\n        assignments: state.assignments.map(a => ({\n          ...a,\n          submissions: a.submissions?.map(s => \n            s.id === submissionId \n              ? { ...s, grade, feedback, status: 'graded' }\n              : s\n          )\n        })),\n        isLoading: false\n      }));\n      \n      return true;\n    } catch (error) {\n      set({ \n        error: 'Erreur lors de la notation',\n        isLoading: false \n      });\n      return false;\n    }\n  },\n\n  fetchSubmissions: async (assignmentId: string) => {\n    set({ isLoading: true, error: null });\n    \n    try {\n      // Simulate API call\n      await new Promise(resolve => setTimeout(resolve, 300));\n      \n      const submissions = mockSubmissions.filter(s => s.assignmentId === assignmentId);\n      \n      set({ \n        submissions,\n        isLoading: false \n      });\n    } catch (error) {\n      set({ \n        error: 'Erreur lors du chargement des soumissions',\n        isLoading: false \n      });\n    }\n  },\n\n  getAssignmentById: (id: string) => {\n    return get().assignments.find(a => a.id === id);\n  },\n\n  getSubmissionsByStudent: (studentId: string) => {\n    return get().submissions.filter(s => s.studentId === studentId);\n  },\n\n  getSubmissionsByAssignment: (assignmentId: string) => {\n    return get().submissions.filter(s => s.assignmentId === assignmentId);\n  }\n}));